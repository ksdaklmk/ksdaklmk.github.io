<h1 id="change-requests-in-fund-transfer-payment">Change requests in fund transfer/payment</h1>
<p><em>updated 5-Nobember-2019</em></p>
<h2 id="-repeating-transaction-"><strong>Repeating transaction</strong></h2>
<p>This change request impacts all types of fund transfer and payment confirm transactions:</p>
<ol>
<li>PromptPay fund transfer</li>
<li>Actual account fund transfer</li>
<li>QR payment</li>
</ol>
<h3 id="-1-inquiry-request-transaction-"><strong>1. Inquiry request transaction</strong></h3>
<p>By receiving a response returned from sending inquiry request, Mirai to check the following:</p>
<ol>
<li>Check if the returned response status is 200 (success) in order to continue with confirm request</li>
<li>If it is success response, Mirai to check further if amount in the respose message is 0.00 before continuing to confirm transaction. In case the amount is 0.00, displays an error message saying &quot;ineligible account, please contact the receiving bank&quot;.</li>
<li>Else check if such response code is in the list of response codes (81, 87, 99, -201) requiring Mirai to retry sending the same request for 3 times until success response has been received or the number of retrying has reached the limit</li>
<li>Else Mirai to log failed status and display an error message</li>
</ol>
<pre><code class="lang-python">request.<span class="hljs-built_in">send</span>(inquiryRequest)
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    <span class="hljs-keyword">if</span> response.amount == <span class="hljs-number">0.00</span>:
        print(errorMessage)
        transaction.<span class="hljs-built_in">log</span>(inquiryRequest, failed)
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">else</span>:
        transaction.<span class="hljs-built_in">log</span>(inquiryRequest, success)
        request.<span class="hljs-built_in">send</span>(confirmRequest)
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> response.code <span class="hljs-keyword">in</span> [<span class="hljs-string">'99'</span>, <span class="hljs-string">'81'</span>, <span class="hljs-string">'87'</span>, <span class="hljs-string">'-201'</span>]:
    tryCount = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> tryCount &lt;= <span class="hljs-number">3</span>:
        request.<span class="hljs-built_in">send</span>(inquiryRequest)
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            transaction.<span class="hljs-built_in">log</span>(inquiryRequest, success)
            request.<span class="hljs-built_in">send</span>(confirmRequest)
            <span class="hljs-built_in">break</span>
        <span class="hljs-keyword">else</span>:
            tryCount += <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>:
        transaction.<span class="hljs-built_in">log</span>(inquiryRequest, failed)
        print(errorMessage)
<span class="hljs-keyword">else</span>:
    transaction.<span class="hljs-built_in">log</span>(inquiryRequest, failed)
    print(errorMessage)
</code></pre>
<h3 id="-2-confirm-request-transaction-"><strong>2. Confirm request transaction</strong></h3>
<p>By receiving a response returned from sending confirm request, Mirai to check the following:</p>
<ol>
<li>Check if the returned response status is 200 (success) in order to complete the transaction</li>
<li>Else check if such response code is in the list of response codes (81, 87, 99, -201) requiring Mirai to retry sending the same confirm request for 3 times until success response has been received or the number of retrying has reached the limit</li>
<li>Else Mirai to reverse the transaction, log failed status and display an error message</li>
</ol>
<pre><code class="lang-python">request.send(confirmRequest)
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    transaction.<span class="hljs-built_in">log</span>(confirmRequest, success)
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> response.code in [<span class="hljs-string">'99'</span>, <span class="hljs-string">'81'</span>, <span class="hljs-string">'87'</span>, <span class="hljs-string">'-201'</span>]:
    tryCount = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> tryCount &lt;= <span class="hljs-number">3</span>:
        request.send(confirmRequest)
        <span class="hljs-keyword">if</span> (response.code = <span class="hljs-string">'55'</span>) <span class="hljs-built_in">or</span> (response.status_code == <span class="hljs-number">200</span>):
            transaction.<span class="hljs-built_in">log</span>(confirmRequest, success)
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">else</span>:
            tryCount += <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>:
        transaction.<span class="hljs-built_in">reverse</span>(sourceAccount, transactionAmount)
        transaction.<span class="hljs-built_in">log</span>(confirmRequest, failed)
        <span class="hljs-keyword">print</span>(errorMessage)
<span class="hljs-keyword">else</span>:
    transaction.<span class="hljs-built_in">reverse</span>(sourceAccount, transactionAmount)
    transaction.<span class="hljs-built_in">log</span>(confirmRequest, failed)
    <span class="hljs-keyword">print</span>(errorMessage)
</code></pre>
